<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cycle Summary</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js">


function changeMonth(offset) {
  const newDate = new Date(viewYear, viewMonth + offset);
  renderCalendar(allEntries, newDate.getMonth(), newDate.getFullYear());
}

</script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js">


function changeMonth(offset) {
  const newDate = new Date(viewYear, viewMonth + offset);
  renderCalendar(allEntries, newDate.getMonth(), newDate.getFullYear());
}

</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js">


function changeMonth(offset) {
  const newDate = new Date(viewYear, viewMonth + offset);
  renderCalendar(allEntries, newDate.getMonth(), newDate.getFullYear());
}

</script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #fffafc; padding: 1em; }
    h1, h2 { text-align: center; }
    .nav-button {
      display: block; margin: 1em auto; background: #c4d7b2;
      color: white; padding: 0.6em 1.2em; border-radius: 20px;
      text-align: center; text-decoration: none; max-width: 250px;
    }
    .legend {
      display: flex; flex-wrap: wrap; gap: 0.5em;
      justify-content: center; margin-bottom: 1em;
    }
    .legend span {
      display: inline-block; padding: 0.4em 0.8em;
      border-radius: 5px; font-size: 0.75em;
    }
    .calendar-nav { display: flex; justify-content: center; gap: 1em; margin: 0.5em 0; }
    .calendar-grid {
      display: grid; grid-template-columns: repeat(7, 1fr);
      gap: 5px; margin-bottom: 1.5em;
    }
    .weekday { font-weight: bold; text-align: center; }
    .day-box {
      padding: 0.6em 0; border-radius: 6px;
      background: #f0f0f0; text-align: center; font-size: 0.85em;
    }
    .deep-red { background: #e76f8a !important; color: white !important; }
    .red { background: #f6b1b7 !important; }
    .blue { background: #b7d7f6 !important; }
    .bold-blue { background: #5f9ed1 !important; color: white !important; }
    .green { background: #c8e6c9 !important; }
    table { width: 100%; border-collapse: collapse; font-size: 1em; }
    th, td { padding: 0.6em; border: 1px solid #ccc; text-align: center; }
    th { background: #eeb7c2; color: white; }
    .chart-container { margin: 2em auto; max-width: 900px; }
  </style>
</head>
<body>
  <h1>Cycle Summary</h1>
  <a class="nav-button" href="index.html">‚Üê Back to Home</a>

  <div class="legend">
    <span style="background:#e76f8a; color:white;">Day 1 Period</span>
    <span style="background:#f6b1b7;">Period</span>
    <span style="background:#b7d7f6;">Fertile (Flashing)</span>
    <span style="background:#5f9ed1; color:white;">Ovulation (Solid)</span>
    <span style="background:#c8e6c9;">Post Ovulation</span>
    <span style="background:#fff0f5;">üíñ Sex</span>
    <span style="background:#fff0f5;">ü´∂ Breast Changes</span>
    <span style="background:#fff0f5;">ü´É Digestive</span>
    <span style="background:#fff0f5;">üòñ Cramps</span>
    <span style="background:#fff0f5;">üîª Spotting</span>
    <span style="background:#fff0f5;">üß† Mood</span>
    <span style="background:#fff0f5;">üå°Ô∏è BBT</span>
  </div>

  <div class="calendar-nav">
    <button onclick="changeMonth(-1)">‚óÄ</button>
    <span id="monthLabel"></span>
    <button onclick="changeMonth(1)">‚ñ∂</button>
  </div>
  <div class="calendar-grid" id="calendarWeekdays"></div>
  <div class="calendar-grid" id="calendarGrid"></div>

  <table id="summaryTable">
    <thead><tr><th>Date</th><th>CD</th><th>Phase</th><th>DPO</th></tr></thead>
    <tbody></tbody>
  </table>

  <div class="chart-container">
    <h2>BBT Over Time</h2>
    <canvas id="bbtChart"></canvas>
  </div>
  <div class="chart-container">
    <h2>CM Pattern</h2>
    <canvas id="cmChart"></canvas>
  </div>
  <div class="chart-container">
    <h2>Symptoms Summary</h2>
    <canvas id="symptomsChart"></canvas>
  </div>
  <div class="chart-container">
    <h2>Mood Timeline</h2>
    <canvas id="moodChart"></canvas>
  </div>
  <div class="chart-container">
    <h2>Sex Activity</h2>
    <canvas id="sexChart"></canvas>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyByvnVx2aZEldUfqS2c6VNC6UJRIOPvGws",
      authDomain: "fertility-tracker-c35ff.firebaseapp.com",
      projectId: "fertility-tracker-c35ff"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
let viewMonth, viewYear, allEntries = [];

    async function loadEntries() {
      const snapshot = await db.collection("entries").orderBy("entryDate").get();
      return snapshot.docs.map(doc => doc.data());
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    function getCurrentCycle(entries) {
      const sorted = entries.slice().reverse();
      const startIndex = sorted.findIndex(e => (e.phase || '').toLowerCase() === 'day1-period');
      if (startIndex === -1) return [];
      return sorted.slice(0, startIndex + 1).reverse();
    }

    function renderCharts(entries) {
      const labels = entries.map(e => formatDate(e.entryDate));
      const bbtData = entries.map(e => parseFloat(e.bbt)).filter(x => !isNaN(x));
      const cmTypes = ['dry', 'sticky', 'creamy', 'watery', 'egg white'];
      const cmData = entries.map(e => cmTypes.indexOf((e.cm || '').toLowerCase())).filter(x => x >= 0);

      const symptoms = { cramps: [], spotting: [], breast: [], digestive: [] };
      entries.forEach(e => {
        symptoms.cramps.push((e.cramps || '').toLowerCase() !== 'none' ? 1 : 0);
        symptoms.spotting.push((e.spotting || '').toLowerCase() !== 'none' ? 1 : 0);
        symptoms.breast.push((e.breastChanges || '').toLowerCase() !== 'none' ? 1 : 0);
        symptoms.digestive.push((e.digestive || '').toLowerCase() !== 'none' ? 1 : 0);
      });

      new Chart(document.getElementById("bbtChart"), {
        type: 'line',
        data: { labels, datasets: [{ label: 'BBT (¬∞C)', data: bbtData, borderColor: 'purple' }] },
        options: { responsive: true }
      });

      new Chart(document.getElementById("cmChart"), {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: 'Cervical Mucus', data: cmData, backgroundColor: '#8ecae6' }]
        },
        options: {
          responsive: true,
          scales: { y: { ticks: { callback: val => cmTypes[val] || '' } } }
        }
      });

      new Chart(document.getElementById("symptomsChart"), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Cramps', data: symptoms.cramps, backgroundColor: '#f28e8e' },
            { label: 'Spotting', data: symptoms.spotting, backgroundColor: '#f2c28e' },
            { label: 'Breast Changes', data: symptoms.breast, backgroundColor: '#c3aed6' },
            { label: 'Digestive', data: symptoms.digestive, backgroundColor: '#a0d9b4' }
          ]
        },
        options: { responsive: true, scales: { x: { stacked: true }, y: { stacked: true } } }
      });

      const moodLabels = [], moodValues = [], moodColors = { Happy: '#ffd700', Calm: '#87cefa', Low: '#ff6b6b', Irritable: '#ffa07a' };
      entries.forEach(e => {
        if (e.mood) {
          moodLabels.push(formatDate(e.entryDate));
          moodValues.push(e.mood);
        }
      });

      new Chart(document.getElementById("moodChart"), {
        type: 'bar',
        data: {
          labels: moodLabels,
          datasets: [{
            label: 'Mood',
            data: moodLabels.map(() => 1),
            backgroundColor: moodValues.map(m => moodColors[m] || '#ccc')
          }]
        },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { display: false } } }
      });

      const sexLabels = [], sexValues = [];
      entries.forEach(e => {
        sexLabels.push(formatDate(e.entryDate));
        sexValues.push((e.sex || '').toLowerCase() === 'yes' ? 1 : 0);
      });

      new Chart(document.getElementById("sexChart"), {
        type: 'bar',
        data: {
          labels: sexLabels,
          datasets: [{ label: 'Sex Logged', data: sexValues, backgroundColor: '#f67280' }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
      });
    }

    async function run() {
      const allEntries = await loadEntries();
      const currentCycle = getCurrentCycle(allEntries);
      renderCharts(currentCycle);
renderCalendar(currentCycle, new Date().getMonth(), new Date().getFullYear());
renderCalendar(currentCycle, new Date().getMonth(), new Date().getFullYear());

      const today = new Date();
      const formatDate = d => d.toISOString().split('T')[0];
      const todayStr = formatDate(today);
      const todayEntry = currentCycle.find(e => formatDate(new Date(e.entryDate)) === todayStr);
      if (todayEntry) {
        const tbody = document.querySelector("#summaryTable tbody");
        const cd1 = new Date(currentCycle[0].entryDate);
        const ov = currentCycle.find(e => (e.opk || '').toLowerCase() === 'solid face');
        const d = new Date(todayEntry.entryDate);
        const cd = Math.floor((d - cd1) / 86400000) + 1;
        const dpo = ov ? Math.max(Math.floor((d - new Date(ov.entryDate)) / 86400000), 0) : "-";
        const row = document.createElement("tr");
        row.innerHTML = `<td>${todayEntry.entryDate}</td><td>${cd}</td><td>${todayEntry.phase || '-'}</td><td>${dpo}</td>`;
        tbody.appendChild(row);
      }

    }
    run();
  


function changeMonth(offset) {
  const newDate = new Date(viewYear, viewMonth + offset);
  renderCalendar(allEntries, newDate.getMonth(), newDate.getFullYear());
}

</script>
</body>
</html>




