<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cycle History</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #fffafc; padding: 1em; }
    h1, h2, h3 { text-align: center; }
    .nav-button {
      display: block; margin: 1em auto; background: #c4d7b2;
      color: white; padding: 0.6em 1.2em; border-radius: 20px;
      text-align: center; text-decoration: none; max-width: 250px;
    }
    .legend {
      display: flex; flex-wrap: wrap; gap: 0.5em;
      justify-content: center; margin-bottom: 1em;
    }
    .legend span {
      display: inline-block; padding: 0.4em 0.8em;
      border-radius: 5px; font-size: 0.75em;
    }
    .calendar-nav {
      display: flex; justify-content: center; gap: 1em; margin: 0.5em 0;
    }
    .calendar-grid {
      display: grid; grid-template-columns: repeat(7, 1fr);
      gap: 5px; margin-bottom: 1.5em;
    }
    .weekday { font-weight: bold; text-align: center; }
    .day-box {
      padding: 0.6em 0; border-radius: 6px;
      background: #f0f0f0; text-align: center;
      font-size: 0.85em;
      position: relative;
    }
    .deep-red { background: #e76f8a !important; color: white !important; }
    .red { background: #f6b1b7 !important; }
    .blue { background: #b7d7f6 !important; }
    .bold-blue { background: #5f9ed1 !important; color: white !important; }
    .green { background: #c8e6c9 !important; }
    .chart-container {
      margin: 2em auto; max-width: 900px;
    }
    table {
      width: 100%; border-collapse: collapse; margin: 1em 0; font-size: 0.95em;
    }
    th, td {
      padding: 0.5em; border: 1px solid #ccc; text-align: center;
    }
    th {
      background: #eeb7c2; color: white;
    }
    .day-box span {
      font-size: 0.9em;
      display: block;
      opacity: 0.7;
      position: absolute;
      bottom: 4px;
      width: 100%;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Cycle History</h1>
  <a class="nav-button" href="index.html">‚Üê Back to Home</a>

  <h2>Cycle Averages</h2>
  <table>
    <thead><tr><th>Avg. Cycle Length</th><th>Avg. Luteal Phase</th><th>Avg. Period Length</th></tr></thead>
    <tbody><tr id="averagesRow"><td>‚Äì</td><td>‚Äì</td><td>‚Äì</td></tr></tbody>
  </table>

  <div class="legend">
    <span style="background:#e76f8a; color:white;">Day 1 Period</span>
    <span style="background:#f6b1b7;">Period</span>
    <span style="background:#b7d7f6;">Fertile (Flashing)</span>
    <span style="background:#5f9ed1; color:white;">Ovulation (Solid)</span>
    <span style="background:#c8e6c9;">Post Ovulation</span>
    <span style="background:#fff0f5;">üíñ Sex</span>
    <span style="background:#fff0f5;">üòñ Cramps</span>
    <span style="background:#fff0f5;">üîª Spotting</span>
    <span style="background:#fff0f5;">üß† Mood</span>
    <span style="background:#fff0f5;">üå°Ô∏è BBT</span>
    <span style="background:#fff0f5;">ü´∂ Breast Changes</span>
    <span style="background:#fff0f5;">ü´É Digestive</span>
  </div>

  <div id="predictionBanner" style="text-align:center; margin-bottom: 1em; font-weight: bold;"></div>

  <div class="calendar-nav">
    <button onclick="changeMonth(-1)">‚óÄ</button>
    <span id="monthLabel"></span>
    <button onclick="changeMonth(1)">‚ñ∂</button>
  </div>

  <div class="calendar-grid" id="calendarWeekdays"></div>
  <div class="calendar-grid" id="calendarGrid"></div>

  <div class="chart-container">
    <h2>BBT Chart</h2>
    <canvas id="bbtChart"></canvas>
  </div>
  <div class="chart-container">
    <h2>CM Pattern</h2>
    <canvas id="cmChart"></canvas>
  </div>
  <div class="chart-container">
    <h2>Average Symptoms</h2>
    <canvas id="symptomsChart"></canvas>
  </div>
  <div class="chart-container">
    <h2>Mood Timeline</h2>
    <canvas id="moodChart"></canvas>
  </div>
  <div class="chart-container">
    <h2>Sex Frequency</h2>
    <canvas id="sexChart"></canvas>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyByvnVx2aZEldUfqS2c6VNC6UJRIOPvGws",
  authDomain: "fertility-tracker-c35ff.firebaseapp.com",
  projectId: "fertility-tracker-c35ff"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let allEntries = [];
let viewMonth = new Date().getMonth();
let viewYear = new Date().getFullYear();

let avgLutealLength = null;
let avgOvulationDay = null;
let avgCycleLength = null;
let avgPeriodLength = null;

async function loadEntries() {
  const snapshot = await db.collection("entries").orderBy("entryDate").get();
  return snapshot.docs.map(doc => doc.data());
}

function groupCycles(entries) {
  const cycles = [];
  let currentCycle = [];

  for (const e of entries) {
    if ((e.phase || '').toLowerCase() === 'day1-period') {
      if (currentCycle.length) cycles.push([...currentCycle]);
      currentCycle = [];
    }
    currentCycle.push(e);
  }

  // Include last cycle only if completed (has solid face and last entry > 4 days ago)
  const lastCycle = [...currentCycle];
  const hasSolidFace = lastCycle.some(e => (e.opk || '').toLowerCase() === 'solid face');
  const lastDate = new Date(lastCycle.at(-1)?.entryDate || 0);
  const daysSinceLastEntry = (new Date() - lastDate) / 86400000;

  if (lastCycle.length > 3 && hasSolidFace && daysSinceLastEntry > 4) {
    cycles.push(lastCycle);
  }

  return cycles;
}

// NEW: groupAllCycles includes all cycles regardless of completeness
function groupAllCycles(entries) {
  const cycles = [];
  let currentCycle = [];

  for (const e of entries) {
    if ((e.phase || '').toLowerCase() === 'day1-period') {
      if (currentCycle.length) cycles.push([...currentCycle]);
      currentCycle = [];
    }
    currentCycle.push(e);
  }

  // Always include the last cycle regardless of completeness
  if (currentCycle.length) cycles.push(currentCycle);

  return cycles;
}

function calculateAverages(cycles) {
  const cycleLengths = [];
  const lutealPhases = [];
  const periodLengths = [];
  let validCount = 0;

  for (const cycle of cycles) {
    const start = new Date(cycle[0].entryDate);
    const end = new Date(cycle[cycle.length - 1].entryDate);
    const duration = (end - start) / 86400000 + 1;

    if (duration < 10) continue;

    const ovIndex = cycle.findIndex(e => (e.opk || '').toLowerCase() === 'solid face');
    if (ovIndex === -1) continue;

    cycleLengths.push(duration);
    lutealPhases.push(cycle.length - ovIndex - 1);

    const periodCount = cycle.filter(e => ['day1-period', 'period'].includes((e.phase || '').toLowerCase())).length;
    periodLengths.push(periodCount);

    validCount++;
  }

  avgCycleLength = cycleLengths.length ? cycleLengths.reduce((a,b) => a + b, 0) / cycleLengths.length : null;
  avgLutealLength = lutealPhases.length ? Math.round(lutealPhases.reduce((a,b) => a + b, 0) / lutealPhases.length) : null;
  avgPeriodLength = periodLengths.length ? (periodLengths.reduce((a,b) => a + b, 0) / periodLengths.length) : null;

  console.log("avgLutealLength:", avgLutealLength);

  const ovulationDays = cycles
    .map(cycle => cycle.findIndex(e => (e.opk || '').toLowerCase() === 'solid face'))
    .filter(index => index !== -1)
    .map(index => index + 1);

  avgOvulationDay = ovulationDays.length
    ? Math.round(ovulationDays.reduce((a, b) => a + b, 0) / ovulationDays.length)
    : null;

  console.log("Average Ovulation Day:", avgOvulationDay);

  const avg = arr => arr.length ? (arr.reduce((a,b) => a+b, 0) / arr.length).toFixed(1) : '‚Äì';

  document.getElementById("averagesRow").innerHTML = `
    <td>${avg(cycleLengths)}</td>
    <td>${avg(lutealPhases)}</td>
    <td>${avg(periodLengths)}</td>
  `;
}

// Prediction icons for next 3 cycles, showing multi-day period icons
function generatePredictionDays() {
  let predictionDays = {};
  const lastDay1 = [...allEntries].reverse().find(e => (e.phase || '').toLowerCase() === 'day1-period');

  if (!lastDay1 || !avgCycleLength || !avgLutealLength) return predictionDays;

  const cycleStart = new Date(lastDay1.entryDate);

  for (let cycleNum = 1; cycleNum <= 3; cycleNum++) {
    const predictedPeriodDate = new Date(cycleStart);
    predictedPeriodDate.setDate(predictedPeriodDate.getDate() + Math.round(avgCycleLength) * cycleNum);

    const ovDate = new Date(predictedPeriodDate);
    ovDate.setDate(ovDate.getDate() - avgLutealLength);

    const fertileStart = new Date(ovDate);
    fertileStart.setDate(fertileStart.getDate() - 5);

    // Fertile window (5 days before ovulation, excluding ovulation day)
    for (let i = 0; i <= 4; i++) {
      const d = new Date(fertileStart);
      d.setDate(d.getDate() + i);
      const key = d.toISOString().split("T")[0];
      predictionDays[key] = 'üü¢';
    }

    // Ovulation day
    const ovKey = ovDate.toISOString().split("T")[0];
    predictionDays[ovKey] = 'üü°';

    // Period days - multi-day icons
    const periodLength = Math.round(avgPeriodLength) || 5; // fallback to 5 days if undefined
    for (let i = 0; i < periodLength; i++) {
      const periodDay = new Date(predictedPeriodDate);
      periodDay.setDate(periodDay.getDate() + i);
      const key = periodDay.toISOString().split("T")[0];
      predictionDays[key] = 'üî¥';
    }
  }
  return predictionDays;
}

function renderCalendar(month, year) {
  const container = document.getElementById("calendarGrid");
  container.innerHTML = "";

  document.getElementById("calendarWeekdays").innerHTML = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun']
    .map(d => `<div class="weekday">${d}</div>`).join('');

  const map = Object.fromEntries(allEntries.map(e => [e.entryDate, e]));
  const predictionDays = generatePredictionDays();

  const start = new Date(year, month, 1);
  const end = new Date(year, month + 1, 0);
  const offset = (start.getDay() + 6) % 7;

  for (let j = 0; j < offset; j++) {
    container.appendChild(document.createElement("div"));
  }

  for (let d = 1; d <= end.getDate(); d++) {
    const date = new Date(year, month, d);
    const key = date.toISOString().split("T")[0];
    const e = map[key];

    const box = document.createElement("div");
    box.className = "day-box";
    box.textContent = d;

    if (e) {
      const phase = (e.phase || '').toLowerCase();
      const opk = (e.opk || '').toLowerCase();
      const emojiStyle = 'font-size: 0.8em; display: block;';

      if (phase === 'day1-period') box.classList.add('deep-red');
      else if (phase === 'period') box.classList.add('red');
      else if (opk === 'flashing face') box.classList.add('blue');
      else if (phase === 'ovulation' || opk === 'solid face') box.classList.add('bold-blue');
      else if (phase === 'post-ovulation') box.classList.add('green');

      if ((e.sex || '').toLowerCase() === 'yes') {
        box.appendChild(Object.assign(document.createElement('span'), {
          textContent: 'üíñ',
          style: emojiStyle
        }));
      }

      if (e.breastChanges && e.breastChanges.toLowerCase() !== 'none') {
        box.appendChild(Object.assign(document.createElement('span'), {
          textContent: 'ü´∂',
          style: emojiStyle
        }));
      }

      if (e.digestive && e.digestive.toLowerCase() !== 'none') {
        box.appendChild(Object.assign(document.createElement('span'), {
          textContent: 'ü´É',
          style: emojiStyle
        }));
      }

      if (e.bbt && !isNaN(parseFloat(e.bbt))) {
        box.appendChild(Object.assign(document.createElement('span'), {
          textContent: 'üå°Ô∏è',
          style: emojiStyle
        }));
      }
    } else if (predictionDays[key]) {
      box.appendChild(Object.assign(document.createElement('span'), {
        textContent: predictionDays[key],
        style: 'font-size: 0.8em; display: block; opacity: 0.6;'
      }));
    }

    if (e) {
      box.title =
        (e.mood ? `Mood: ${e.mood}\n` : '') +
        ((e.cramps || '').toLowerCase() !== 'none' ? `Cramps: ${e.cramps}\n` : '') +
        ((e.spotting || '').toLowerCase() !== 'none' ? `Spotting: ${e.spotting}\n` : '') +
        ((e.sex || '').toLowerCase() === 'yes' ? 'Sex: Yes\n' : '') +
        (e.bbt ? `BBT: ${e.bbt}\n` : '') +
        ((e.breastChanges || '').toLowerCase() !== 'none' ? 'Breast Changes\n' : '') +
        ((e.digestive || '').toLowerCase() !== 'none' ? 'Digestive Symptoms\n' : '');
    }

    container.appendChild(box);
  }

  viewMonth = month;
  viewYear = year;

  document.getElementById("monthLabel").textContent = new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' });
}

function changeMonth(offset) {
  const newDate = new Date(viewYear, viewMonth + offset);
  viewMonth = newDate.getMonth();
  viewYear = newDate.getFullYear();

  renderCalendar(viewMonth, viewYear);
  renderCharts(groupCycles(allEntries));
}

function renderCharts(cycles) {
  // Filter BBT entries by current view month and year
  const bbtEntries = allEntries
    .filter(e => {
      const d = new Date(e.entryDate);
      return d.getMonth() === viewMonth && d.getFullYear() === viewYear && !isNaN(parseFloat(e.bbt));
    })
    .sort((a, b) => new Date(a.entryDate) - new Date(b.entryDate));

  const bbtData = bbtEntries.map(e => parseFloat(e.bbt));
  const bbtLabels = bbtEntries.map(e => {
    const d = new Date(e.entryDate);
    return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
  });
  console.log('BBT entries:', bbtEntries);
  console.log('BBT data:', bbtData);
  console.log('BBT labels:', bbtLabels);

  // Calculate averages per cycle for CM, symptoms, mood
  const cmTypes = ['dry', 'sticky', 'creamy', 'watery', 'egg white'];
  const cmAvgPerCycle = [];
  const symptomsAvg = { cramps: 0, spotting: 0, mood: 0, breast: 0, digestive: 0 };
  const moodLabels = [];
  const moodValues = [];

  // Use original cycles for general averages
  cycles.forEach((cycle) => {
    // CM average for this cycle
    const cmValues = cycle
      .map(e => cmTypes.indexOf((e.cm || '').toLowerCase()))
      .filter(v => v >= 0);
    cmAvgPerCycle.push(cmValues.length ? cmValues.reduce((a,b) => a+b, 0) / cmValues.length : null);

    // Symptoms average for this cycle
    symptomsAvg.cramps += cycle.filter(e => (e.cramps || '').toLowerCase() !== 'none').length / cycle.length;
    symptomsAvg.spotting += cycle.filter(e => (e.spotting || '').toLowerCase() !== 'none').length / cycle.length;
    symptomsAvg.mood += cycle.filter(e => e.mood).length / cycle.length;
    symptomsAvg.breast += cycle.filter(e => (e.breastChanges || '').toLowerCase() !== 'none').length / cycle.length;
    symptomsAvg.digestive += cycle.filter(e => (e.digestive || '').toLowerCase() !== 'none').length / cycle.length;

    // Mood timeline data
    cycle.forEach(e => {
      if (e.mood) {
        moodLabels.push(e.entryDate);
        moodValues.push(e.mood);
      }
    });
  });

  // Now use groupAllCycles for sex frequency ‚Äî includes incomplete cycles
  const allCycles = groupAllCycles(allEntries);
  const sexFreqPerCycle = [];
  allCycles.forEach(cycle => {
    const sexCount = cycle.filter(e => (e.sex || '').trim().toLowerCase() === 'yes').length;
    sexFreqPerCycle.push(sexCount);
  });

  // Calculate averages across all cycles for symptoms
  const cycleCount = cycles.length || 1;
  Object.keys(symptomsAvg).forEach(key => {
    symptomsAvg[key] /= cycleCount;
  });

  // Average CM for all cycles
  const validCmValues = cmAvgPerCycle.filter(v => v !== null);
  const avgCm = validCmValues.length
    ? validCmValues.reduce((a,b) => a+b, 0) / validCmValues.length
    : 0;

  // Average sex frequency across all cycles including incomplete
  const avgSexFreq = sexFreqPerCycle.length
    ? sexFreqPerCycle.reduce((a,b) => a+b, 0) / sexFreqPerCycle.length
    : 0;

  console.log('Sex counts per cycle:', sexFreqPerCycle);
  console.log('Average sex frequency:', avgSexFreq);

  // Mood color mapping
  const moodColors = { Happy: '#ffd700', Calm: '#87cefa', Low: '#ff6b6b', Irritable: '#ffa07a' };

  // Destroy previous charts if exist to avoid duplicates
  if(window.moodChartInstance) window.moodChartInstance.destroy();
  if(window.sexChartInstance) window.sexChartInstance.destroy();
  if(window.bbtChartInstance) window.bbtChartInstance.destroy();
  if(window.cmChartInstance) window.cmChartInstance.destroy();
  if(window.symptomsChartInstance) window.symptomsChartInstance.destroy();

  // Mood chart
  window.moodChartInstance = new Chart(document.getElementById("moodChart"), {
    type: 'bar',
    data: {
      labels: moodLabels,
      datasets: [{
        label: 'Mood',
        data: moodLabels.map(() => 1),
        backgroundColor: moodValues.map(m => moodColors[m] || '#ccc')
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { y: { display: false } }
    }
  });

  // Sex frequency chart ‚Äî single bar showing average over all cycles
  window.sexChartInstance = new Chart(document.getElementById("sexChart"), {
    type: 'bar',
    data: {
      labels: ['Average Sex Frequency'],
      datasets: [{
        label: 'Avg Sex Frequency (per cycle)',
        data: [avgSexFreq],
        backgroundColor: '#f67280'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
            precision: 0
          }
        },
        x: {
          title: {
            display: true,
            text: 'Overall Average'
          }
        }
      }
    }
  });

  // BBT chart
  window.bbtChartInstance = new Chart(document.getElementById("bbtChart"), {
    type: 'line',
    data: {
      labels: bbtLabels,
      datasets: [{
        label: "BBT",
        data: bbtData,
        borderColor: 'purple',
        fill: false,
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { title: { display: true, text: 'Temperature (¬∞C)' } },
        x: { title: { display: true, text: 'Date' } }
      }
    }
  });

  // CM chart
  window.cmChartInstance = new Chart(document.getElementById("cmChart"), {
    type: 'line',
    data: {
      labels: Array.from({length: 5}, (_, i) => i + 1), // Fixed length for CM types
      datasets: [{
        label: "Avg CM",
        data: Array(5).fill(avgCm), // Use avgCm for all 5 CM types (consistent)
        borderColor: 'teal',
        fill: false,
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          title: { display: true, text: 'CM Type (numeric)' },
          ticks: { callback: val => ['dry','sticky','creamy','watery','egg white'][val] || val }
        },
        x: { title: { display: true, text: 'Cycle' } }
      }
    }
  });

  // Symptoms chart
  window.symptomsChartInstance = new Chart(document.getElementById("symptomsChart"), {
    type: 'bar',
    data: {
      labels: ['Cramps', 'Spotting', 'Mood', 'Breast Changes', 'Digestive'],
      datasets: [{
        label: 'Average Occurrence',
        data: [
          symptomsAvg.cramps,
          symptomsAvg.spotting,
          symptomsAvg.mood,
          symptomsAvg.breast,
          symptomsAvg.digestive
        ],
        backgroundColor: ['#f28e8e', '#f2c28e', '#a8d0e6', '#c3aed6', '#a0d9b4']
      }]
    },
    options: { responsive: true }
  });
}

async function run() {
  allEntries = await loadEntries();
  const cycles = groupCycles(allEntries);
  calculateAverages(cycles);
  const today = new Date();
  renderCalendar(today.getMonth(), today.getFullYear());
  renderCharts(cycles);
}

run();
</script>
</body>
</html>
